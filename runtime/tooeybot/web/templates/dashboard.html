{% extends "base.html" %}

{% block title %}Dashboard - Tooeybot{% endblock %}
{% block header %}Dashboard{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
        <!-- Pending Tasks -->
        <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
            <dt class="truncate text-sm font-medium text-gray-500">Pending Tasks</dt>
            <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-900">{{ pending_count }}</dd>
        </div>
        
        <!-- Completed Tasks -->
        <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
            <dt class="truncate text-sm font-medium text-gray-500">Completed Tasks</dt>
            <dd class="mt-1 text-3xl font-semibold tracking-tight text-green-600">{{ completed_count }}</dd>
        </div>
        
        <!-- Beliefs -->
        <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
            <dt class="truncate text-sm font-medium text-gray-500">Active Beliefs</dt>
            <dd class="mt-1 text-3xl font-semibold tracking-tight text-indigo-600">{{ belief_count }}</dd>
        </div>
        
        <!-- Skills -->
        <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
            <dt class="truncate text-sm font-medium text-gray-500">Skills</dt>
            <dd class="mt-1 text-3xl font-semibold tracking-tight text-purple-600">{{ skill_count }}</dd>
        </div>
    </div>

    <!-- Phase 2: Budget and Curiosity Status -->
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
        <!-- Current Cycles -->
        <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
            <dt class="truncate text-sm font-medium text-gray-500">Current Task Cycles</dt>
            <dd class="mt-1 text-3xl font-semibold tracking-tight text-blue-600">{{ cycle_count }}</dd>
            <dd class="mt-1 text-xs text-gray-400">{{ budget_status.iterations if budget_status else 'N/A' }}</dd>
        </div>
        
        <!-- Budget Status -->
        <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
            <dt class="truncate text-sm font-medium text-gray-500">Budget Status</dt>
            <dd class="mt-1 text-3xl font-semibold tracking-tight {% if budget_status and budget_status.can_continue %}text-green-600{% else %}text-red-600{% endif %}">
                {% if budget_status and budget_status.can_continue %}OK{% else %}Limit{% endif %}
            </dd>
            <dd class="mt-1 text-xs text-gray-400">Failures: {{ budget_status.failures if budget_status else '0/3' }}</dd>
        </div>
        
        <!-- Curiosity Today -->
        <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
            <dt class="truncate text-sm font-medium text-gray-500">Curiosity Tasks Today</dt>
            <dd class="mt-1 text-3xl font-semibold tracking-tight text-amber-600">{{ curiosity_stats.created if curiosity_stats else 0 }}</dd>
            <dd class="mt-1 text-xs text-gray-400">Remaining: {{ curiosity_stats.remaining_budget if curiosity_stats else 5 }}</dd>
        </div>
        
        <!-- Task Origins -->
        <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
            <dt class="truncate text-sm font-medium text-gray-500">Task Origins</dt>
            <dd class="mt-1 text-xs">
                {% if task_origins %}
                <span class="text-gray-600">User: {{ task_origins.user or 0 }}</span> |
                <span class="text-amber-600">Curiosity: {{ task_origins.curiosity or 0 }}</span>
                {% else %}
                <span class="text-gray-400">No data</span>
                {% endif %}
            </dd>
        </div>
    </div>

    <!-- Messages Status -->
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
        <!-- Unread Messages -->
        <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
            <dt class="truncate text-sm font-medium text-gray-500">ğŸ’¬ Unread Messages</dt>
            <dd class="mt-1 text-3xl font-semibold tracking-tight {% if message_stats and message_stats.unread_for_user > 0 %}text-indigo-600{% else %}text-gray-400{% endif %}">
                {{ message_stats.unread_for_user if message_stats else 0 }}
            </dd>
            <dd class="mt-1">
                <a href="/messages" class="text-xs text-indigo-600 hover:text-indigo-500">View messages â†’</a>
            </dd>
        </div>
        
        <!-- Waiting for You -->
        <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
            <dt class="truncate text-sm font-medium text-gray-500">â³ Waiting for You</dt>
            <dd class="mt-1 text-3xl font-semibold tracking-tight {% if message_stats and message_stats.waiting_user > 0 %}text-amber-600{% else %}text-gray-400{% endif %}">
                {{ message_stats.waiting_user if message_stats else 0 }}
            </dd>
            <dd class="mt-1 text-xs text-gray-400">Questions from agent</dd>
        </div>
        
        <!-- Waiting for Agent -->
        <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
            <dt class="truncate text-sm font-medium text-gray-500">ğŸ¤– Waiting for Agent</dt>
            <dd class="mt-1 text-3xl font-semibold tracking-tight {% if message_stats and message_stats.waiting_agent > 0 %}text-blue-600{% else %}text-gray-400{% endif %}">
                {{ message_stats.waiting_agent if message_stats else 0 }}
            </dd>
            <dd class="mt-1 text-xs text-gray-400">Your instructions</dd>
        </div>
        
        <!-- Open Threads -->
        <div class="overflow-hidden rounded-lg bg-white px-4 py-5 shadow sm:p-6">
            <dt class="truncate text-sm font-medium text-gray-500">ğŸ“‹ Open Threads</dt>
            <dd class="mt-1 text-3xl font-semibold tracking-tight text-gray-600">
                {{ message_stats.open_threads if message_stats else 0 }}
            </dd>
            <dd class="mt-1 text-xs text-gray-400">Active conversations</dd>
        </div>
    </div>

    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
        <!-- Active Task -->
        <div class="overflow-hidden rounded-lg bg-white shadow">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Active Task</h3>
            </div>
            <div class="px-4 py-5 sm:p-6">
                {% if active_task %}
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <span class="text-lg font-medium text-gray-900">{{ active_task.task_id }}</span>
                        <div class="flex items-center space-x-2">
                            <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium
                                {% if active_task.priority == 'high' %}bg-red-100 text-red-800
                                {% elif active_task.priority == 'medium' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-green-100 text-green-800{% endif %}">
                                {{ active_task.priority }}
                            </span>
                            {% if active_task.origin and active_task.origin.value != 'user' %}
                            <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-amber-100 text-amber-800">
                                {{ active_task.origin.value }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">{{ active_task.description[:200] }}...</p>
                    
                    <!-- Cycle Progress -->
                    <div class="mt-2 flex items-center text-xs text-gray-500">
                        <span>ğŸ”„ Cycles: {{ cycle_count }}</span>
                        <span class="mx-2">|</span>
                        <span>ğŸ“Š {{ budget_status.iterations if budget_status else 'N/A' }}</span>
                    </div>
                    
                    <div class="mt-4 flex space-x-2">
                        <form action="/tasks/tick" method="post">
                            <button type="submit" class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">
                                â–¶ Run Tick
                            </button>
                        </form>
                        <a href="/cycles/{{ active_task.task_id }}" class="inline-flex items-center rounded-md bg-gray-100 px-3 py-2 text-sm font-semibold text-gray-700 shadow-sm hover:bg-gray-200">
                            ğŸ“ˆ View Cycles
                        </a>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-6">
                    <p class="text-gray-500">No active task</p>
                    <a href="/tasks" class="mt-2 inline-flex items-center text-indigo-600 hover:text-indigo-500">
                        Create a task â†’
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Health Status -->
        <div class="overflow-hidden rounded-lg bg-white shadow">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Health Status</h3>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <ul class="space-y-2">
                    {% for check_name, status in health.items() %}
                    <li class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">{{ check_name }}</span>
                        <span class="inline-flex items-center">
                            {% if status.ok %}
                            <span class="text-green-500">âœ“</span>
                            {% else %}
                            <span class="text-red-500">âœ—</span>
                            {% endif %}
                            <span class="ml-2 text-xs text-gray-500">{{ status.message[:30] }}</span>
                        </span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <!-- Recent Events -->
    <div class="overflow-hidden rounded-lg bg-white shadow">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
            <h3 class="text-lg font-medium leading-6 text-gray-900">Recent Events</h3>
        </div>
        <div class="px-4 py-5 sm:p-6">
            {% if recent_events %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Task</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Details</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for event in recent_events %}
                        <tr>
                            <td class="px-3 py-2 text-xs text-gray-500">{{ event.timestamp[:19] if event.timestamp else 'N/A' }}</td>
                            <td class="px-3 py-2">
                                <span class="inline-flex items-center rounded px-2 py-0.5 text-xs font-medium
                                    {% if event.event_type == 'command' %}bg-blue-100 text-blue-800
                                    {% elif event.event_type == 'task_update' %}bg-purple-100 text-purple-800
                                    {% elif event.event_type == 'error' %}bg-red-100 text-red-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ event.event_type }}
                                </span>
                            </td>
                            <td class="px-3 py-2 text-xs text-gray-600">{{ event.context.task_id if event.context else '-' }}</td>
                            <td class="px-3 py-2 text-xs text-gray-600">
                                {% if event.execution and event.execution.commands %}
                                {{ event.execution.commands[0].cmd if event.execution.commands else '-' }}
                                {% else %}
                                {{ event.data[:50] if event.data else '-' }}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-4">No recent events</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
